# 1.2 Hive 架构原理

## 任务目的

- 熟记 Hive 内部架构的四个组成部分
- 了解 Hive 和 RDBMS 的区别

## 任务清单

- 任务1：Hive 架构原理
- 任务2：Hive 和 RDBMS 的对比

## 任务步骤

### 任务1：Hive 架构原理

![Vditor](https://cdn.jsdelivr.net/gh/wfy-belief/PicGo-images/img/63020311.jpg)

图1

　　从上图看出 Hive 的内部架构由四部分组成：

**1. 用户接口：Client**

- **CLI**：Shell 终端命令行（Command Line Interface），采用交互形式使用 Hive 命令行与 Hive 进行交互，**最常用（学习，调试，生产）**

- JDBC/ODBC

  ：是 Hive 的基于 JDBC 操作提供的客户端，用户（开发员，运维人员）通过这连接至 Hive server 服务

  - **跨语言服务 Thrift Server**：Thrift 是 Facebook 开发的一个软件框架，可以用来进行可扩展且跨语言的服务的开发， Hive 集成了该服务，能让不同的编程语言调用 Hive 的接口。

- **Web UI** ：通过浏览器访问 Hive 　　

**2. 元数据存储：Metastore**

- 元数据，通俗的讲，就是**存储在 Hive 中的数据的描述信息**。Hive 中的元数据通常包括：表名、表所属的数据库（默认是default）、表的列和分区及其属性，表的类型（是否为外部表等），表的数据所在目录等。
- MetaStore 默认存在**自带的 Derby 数据库**中。缺点就是不适合多用户操作，并且数据存储目录不固定。数据库跟着 Hive 走，极度不方便管理。
- **解决方案**：通常将其存在我们**自己创建的 MySQL 库中**（本地 或 远程）
- **Hive 和 MySQL 之间通过 MetaStore 服务交互**

**3. 驱动器 Driver**

　　驱动器 Driver 的主要组件：**解析器（SQL Parser）**、**编译器（Physical Plan）**，**优化器（Query Optimizer）** 和 **执行器（Execution）**。

　　（1）**解析器（SQL Parser）**：将 SQL 字符串转换成抽象语法树 AST，这一步一般都用第三方工具库完成，比如 antlr；对 AST 进行语法分析，比如表是否存在、字段是否存在、SQL 语义是否有误。

　　（2）**编译器（Physical Plan）**：将 AST 编译生成逻辑执行计划。

　　（3）**优化器（Query Optimizer）**：对逻辑执行计划进行优化。

　　（4）**执行器（Execution）**：把逻辑执行计划转换成可以运行的物理计划。对于 Hive 来说，就是 MapReduce/Spark。

　　**执行流程**：HiveQL 通过命令行或者客户端提交，经过解析器和编译器，运用 MetaStore 中的元数据进行类型检测和语法分析，生成一个逻辑方案，然后通过的优化处理，产生一个 MapReduce 任务。

**4. Hadoop**

　　使用 HDFS 进行存储，使用 MapReduce 进行计算。

### 任务2：Hive 和 RDBMS 的对比

　　由于 Hive 采用了**类似 SQL 的查询语言 HQL(Hive Query Language)**，因此很容易将 Hive 理解为数据库。其实从结构上来看，Hive 和数据库除了拥有类似的查询语言，再无类似之处。本文将从多个方面来阐述 Hive 和数据库的差异。数据库可以用在 Online 的应用中，但是**Hive是为数据仓库而设计的**，清楚这一点，有助于从应用角度理解Hive的特性。

**1. 查询语言**

　　由于 SQL 被广泛的应用在数据仓库中，因此，专门针对 Hive 的特性设计了**类 SQL 的查询语言 HQL**。熟悉 SQL 开发的开发者可以很方便的使用 Hive 进行开发。

**2. 数据存储位置**

　　Hive 是建立在 Hadoop 之上的，所有 **Hive 的数据都是存储在 HDFS 中**的。而**数据库**则可以将数据保存在**块设备或者本地文件系统**中。

**3. 数据格式**

　　Hive 中**没有定义专门的数据格式**，**数据格式可以由用户指定**，用户定义数据格式需要指定三个属性：**列分隔符（通常为空格、”\t”、”\x001″）**、**行分隔符（”\n”）\**以及\**读取文件数据的方法**（Hive中默认有三个文件格式 TextFile、SequenceFile 以及 RCFile）。

　　由于在加载数据的过程中，不需要从用户数据格式到 Hive 定义的数据格式的转换，因此，Hive在加载的过程中不会对数据本身进行任何修改，而只是**将数据内容复制或者移动到相应的 HDFS 目录中**。

　　而在数据库中，不同的数据库有不同的存储引擎，**定义了自己的数据格式**。所有**数据都会按照一定的组织存储**，因此，数据库加载数据的过程会比较耗时。

**4. 数据更新**

　　由于 Hive 是针对数据仓库应用设计的，而数据仓库的内容是**读多写少**的。因此，**Hive中不建议对数据的改写**，所有的数据都是在加载的时候确定好的。

　　而数据库中的数据通常是**需要经常进行修改**的 ， 因此可以使用 `INSERT INTO … VALUES` 添加数据 ， 使用 `UPDATE … SET` 修改数据。

**5. 索引**

　　**Hive 不建立索引**：Hive 在加载数据的过程中不会对数据进行任何处理，甚至不会对数据进行扫描，因此也没有对数据中的某些 Key 建立索引。Hive 要访问数据中满足条件的特定值时，需要**暴力扫描整个数据**，因此**访问延迟较高**。由于 MapReduce 的引入， Hive 可以并行访问数据，因此即使没有索引，对于大数据量的访问，Hive 仍然可以体现出优势。

　　数据库中，通常会**针对一个或者几个列建立索引**，因此对于少量的特定条件的数据的访问，数据库可以有很高的效率，较低的延迟。由于数据的访问延迟较高，决定了 Hive 不适合在线数据查询。

**6. 执行器**

　　Hive 中大多数查询的执行是通过 Hadoop 提供的 **MapReduce** 来实现的。而数据库通常有自己的执行引擎。

**7. 执行延迟**

　　Hive 在查询数据的时候，由于没有索引，**需要扫描整个表，因此延迟较高**。另外一个导致 Hive 执行延迟高的因素是 **MapReduce 框架**。由于 MapReduce 本身具有较高的延迟，因此在利用 MapReduce 执行 Hive 查询时，也会有较高的延迟。

　　相对的，**数据库的执行延迟较低**。当然，这个也是有条件的，即数据规模较小，当数据规模大到超过数据库的处理能力的时候，Hive 的并行计算显然能体现出优势。

**8. 可扩展性**

　　由于 Hive 是建立在 Hadoop 之上的，因此 Hive 的可扩展性是和 Hadoop 的可扩展性是一致的（世界上最大的 Hadoop 集群在 Yahoo!，2009 年的规模在 4000 台节点左右）。

　　而数据库由于 ACID 语义的严格限制，**扩展行非常有限**。目前最先进的并行数据库 Oracle 在理论上的扩展能力也只有 100 台左右。

**9. 处理数据规模**

　　由于 Hive 建立在集群上并可以利用 MapReduce 进行并行计算，因此可以**支持很大规模的数据**；对应的，**数据库可以支持的数据规模较小**。

- Hive 和 RDBMS 的对比表：

| 对比项       | Hive                                             | RDBMS                    |
| ------------ | ------------------------------------------------ | ------------------------ |
| 查询语言     | HQL                                              | SQL                      |
| 数据存储位置 | HDFS                                             | Raw Device 或者 Local FS |
| 数据格式     | 用户自定义                                       | 系统决定                 |
| 数据更新     | 从 Hive 0.14开始支持（只能在支持事务的表上执行） | 支持                     |
| 索引         | 无                                               | 有                       |
| 执行器       | MapReduce                                        | Executor                 |
| 执行延迟     | 高                                               | 低                       |
| 可扩展性     | 高                                               | 有限                     |
| 处理数据规模 | 大                                               | 小                       |

　　总结： Hive 具有 SQL 数据库的外表，但应用场景完全不同， **Hive 适合用来做批量海量数据统计分析，也就是数据仓库。**